<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Absensi</title>
  <link rel="icon" type="image/png" href="icon-absensi.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --hijau: #4CAF50;
      --biru: #2196F3;
      --merah: #f44336;
      --abu: #607d8b;
      --ungu: #673ab7;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f7f8;
    }

    .container {
      max-width: 1100px;
      margin: auto;
      padding: 16px;
    }

    h2 {
      font-size: 1.8rem;
      color: #2c3e50;
      margin-bottom: 24px;
      text-align: center;
      padding-bottom: 8px;
      position: relative;
    }

    h2::after {
      content: '';
      display: block;
      width: 60px;
      height: 4px;
      background: var(--hijau);
      margin: 8px auto 0;
      border-radius: 2px;
    }

    .header-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .jam-atas {
      font-weight: bold;
      background: white;
      padding: 6px 12px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .card-header button {
      text-decoration: none;
      color: #2c3e50;
      font-weight: bold;
    }

    button {
      color: white;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      padding: 8px 14px;
      border-radius: 6px;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }

    .filter-button {
      background-color: #e0e0e0;
      margin-left: 5px;
      color: #333;
    }

    .filter-button:hover {
      background-color: #d0d0d0;
    }

    .filter-button.active {
      background-color: var(--hijau);
      color: white;
      font-weight: bold;
    }

    .filter-reset {
      background-color: var(--abu);
      color: white;
    }

    .table-responsive {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    th,
    td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      text-align: left;
      vertical-align: middle;
    }

    th {
      background: var(--hijau);
      color: white;
    }

    .status-tepat {
      color: green;
    }

    .status-terlambat {
      color: red;
    }

    .status-bolos {
      color: #b71c1c;
    }

    .status-izin,
    .status-sakit {
      color: #f57c00;
    }

    .btn-edit,
    .btn-hapus {
      font-weight: bold;
      cursor: pointer;
    }

    .btn-edit {
      color: var(--biru);
    }

    .btn-hapus {
      color: var(--merah);
    }

    #daftarPeserta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      list-style: none;
      padding: 0;
    }

    #daftarPeserta li {
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      text-align: center;
    }

    #daftarPeserta img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 50%;
      margin-bottom: 8px;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      display: none;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 10px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
      animation: fadeIn 0.3s;
    }

    .modal-rekap .modal-content {
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    #rekapChart {
      max-height: 280px;
      width: 100% !important;
      margin-bottom: 20px;
    }

    #customAlert {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      padding: 15px 20px;
      border-radius: 8px;
      font-weight: bold;
      color: white;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      transform: translateX(120%);
      transition: transform 0.4s ease-in-out;
    }

    #customAlert.show {
      transform: translateX(0);
    }

    .rekap-hadir {
      background-color: #d4edda !important;
    }

    .rekap-sakit {
      background-color: #f8d7da !important;
    }

    .rekap-izin {
      background-color: #fff3cd !important;
    }

    .rekap-bolos {
      background-color: #f5c6cb !important;
    }

    .setting-box {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      background-color: #f0f9f0;
      padding: 1.25rem;
      border-radius: 8px;
      border-left: 5px solid var(--hijau);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }
  </style>
</head>

<body style="display: flex; flex-direction: column; min-height: 100vh;">
  <div class="container">
    <div class="header-container">
      <button onclick="logout()" style="background-color: var(--merah);">Kembali</button>
      <h2>Dasbor Admin</h2>
      <div class="jam-atas" id="jamSekarang">--:--:--</div>
    </div>

    <div class="accordion" id="accordionAdmin">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
            data-bs-target="#collapseOne">
            Form Tambah Peserta
          </button>
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionAdmin">
          <div class="accordion-body">
            <form id="formTambah">
              <input type="text" id="namaBaru" placeholder="Nama Peserta" required class="form-control mb-2">
              <input type="text" id="nomorBaru" placeholder="Nomor Unik" required class="form-control mb-2">
              <input type="file" id="fotoBaru" accept="image/*" required class="form-control mb-2">
              <button type="submit" style="background-color: var(--biru);" class="w-100">Tambah Peserta</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="accordion-item" style="margin-top: 10px;">
      <div id="collapseSettings" class="accordion-collapse collapse show" data-bs-parent="#accordionAdmin">
        <div class="accordion-body">
          <div class="setting-box">
            <svg xmlns="http://www.w3.org/2000/svg" height="32px" viewBox="0 0 24 24" width="32px" fill="#4CAF50">
              <path d="M0 0h24v24H0z" fill="none" />
              <path
                d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z" />
            </svg>

            <div>
              <label for="jamBatasPulang" class="form-label fw-bold">Batas Awal Pulang Tepat Waktu</label>
              <input type="time" id="jamBatasPulang" value="16:00" class="form-control" style="max-width: 150px;">
              <div class="form-text mt-1">
                Peserta yang absen pulang <strong>sebelum</strong> jam ini akan berstatus "Bolos".
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <h2 class="mt-4">Data Absensi</h2>
    <div class="filter-row">
      <input type="text" id="cariInput" placeholder="Cari nama..." oninput="renderTabel(dataTabelSaatIni, true)"
        class="form-control" style="flex-grow: 1;">
      <div id="filterBMH" class="btn-group" role="group">
        <button id="bulanBtn" class="filter-button">Bulan</button>
        <button id="mingguBtn" class="filter-button" disabled>Minggu</button>
        <button id="hariBtn" class="filter-button" disabled>Hari</button>
        <button id="resetHariBtn" class="filter-button filter-reset" title="Kembali ke tampilan awal">Reset</button>
      </div>
    </div>

    <div class="rekap" id="rekapInfo" style="font-size: 0.9em; margin-bottom: 10px;"></div>
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>Nama</th>
            <th>Nomor</th>
            <th>Waktu Pulang</th>
            <th>Status</th>
            <th>Alasan</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="absenBody"></tbody>
      </table>
    </div>

    <div class="actions-container mt-3" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
      <button onclick="exportCSV()" style="background-color:#0288d1;">Download Full Data</button>
      <button onclick="downloadHarian()" style="background-color:var(--ungu);">Download Tampilan Harian</button>
      <button onclick="tampilkanRekap()" style="background-color:var(--biru);">Tampilkan Rekap</button>
      <button onclick="tambahAbsenManual()" style="background-color:#ff9800;">Tambah Absen Manual</button>
      <button onclick="hapusSemuaData()" style="background-color:var(--merah);">Hapus Semua Absensi</button>
    </div>

    <h2 class="mt-4">Daftar Peserta Terdaftar</h2>
    <ul id="daftarPeserta"></ul>
  </div>

  <div id="modal-container"></div>
  <div id="customAlert"></div>

  <footer style="background:#2c3e50;color:white;text-align:center;padding:12px;margin-top:auto;">
    <p class="mb-0">&copy; 2025 Absensi Digital • Dibuat oleh <a href="https://portfolio-chx.netlify.app/"
        target="_blank" class="text-info text-decoration-none">Chandra</a></p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, remove, update } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    // --- KONFIGURASI & VARIABEL GLOBAL ---
    const firebaseConfig = { apiKey: "AIzaSyDOmBwvur0gJVvyzqLff-e_YjFpkyYvOCM", authDomain: "absensi-chx.firebaseapp.com", databaseURL: "https://absensi-chx-default-rtdb.firebaseio.com", projectId: "absensi-chx", storageBucket: "absensi-chx.appspot.com", messagingSenderId: "891248981960", appId: "1:891248981960:web:c0060ff1de18e61608b2fd" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const pesertaRef = ref(db, 'peserta');
    const absensiRef = ref(db, 'absensi');

    let dataAbsensiGlobal = {}, dataPesertaGlobal = {}, mingguAktif = {}, hariAktif = [], dataTabelSaatIni = {};
    let rekapChartInstance = null;

    function logout() {
      showAlert('Anda telah keluar.', 'info');
      setTimeout(() => {
        localStorage.removeItem("isAdmin");
        localStorage.removeItem("adminUser");
        window.location.href = "login.html";
      }, 1500);
    }
    window.logout = logout; // Agar bisa dipanggil dari HTML


    // --- UTILITAS & UI ---
    function showAlert(pesan, tipe = "sukses") {
      const alertBox = document.getElementById("customAlert");
      alertBox.textContent = pesan;
      alertBox.style.backgroundColor = tipe === 'gagal' ? 'var(--merah)' : tipe === 'info' ? 'var(--biru)' : 'var(--hijau)';
      alertBox.classList.add("show");
      setTimeout(() => alertBox.classList.remove("show"), 3000);
    }

    function createModal(id, title, contentHTML, actions) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = id;
      modal.innerHTML = `<div class="modal-content">${title ? `<h3>${title}</h3>` : ''}${contentHTML}<div class="modal-actions">${actions.map(a => `<button id="${a.id}" style="background-color: ${a.color};">${a.text}</button>`).join('')}</div></div>`;
      document.getElementById('modal-container').appendChild(modal);
      return modal;
    }

    function showDropdown(items, title, callback) {
      const id = 'dropdown-modal';
      let existingModal = document.getElementById(id);
      if (existingModal) existingModal.remove();

      const content = items.map(item => `<button data-value="${item.val}" class="dropdown-item w-100 mb-2" style="background-color:var(--hijau);">${item.lbl}</button>`).join('');
      const modal = createModal(id, title, `<div class="dropdown-modal-content">${content}</div>`, [{ id: 'batal-dropdown', text: 'Batal', color: '#ccc' }]);

      modal.style.display = 'flex';
      modal.onclick = e => {
        if (e.target.classList.contains('dropdown-item')) {
          callback(e.target.dataset.value);
          modal.remove();
        } else if (e.target.id === 'batal-dropdown' || e.target === modal) {
          modal.remove();
        }
      };
    }

    // --- RENDER & FILTER DATA ABSENSI (LOGIKA DIPERBAIKI) ---
    async function initData() {
      // DIPERBAIKI: Mengambil data peserta dan absensi secara bersamaan
      try {
        const [pesertaSnap, absensiSnap] = await Promise.all([get(pesertaRef), get(absensiRef)]);
        dataPesertaGlobal = pesertaSnap.val() || {};
        dataAbsensiGlobal = absensiSnap.val() || {};

        renderDaftarPeserta(dataPesertaGlobal);
        renderAbsensiAwal();
        initBMHControls();
      } catch (error) {
        console.error("Gagal mengambil data awal:", error);
        showAlert("Gagal memuat data dari database.", "gagal");
      }
    }

    // --- MANAJEMEN PESERTA (DIPERBAIKI) ---
    function renderDaftarPeserta(data) {
      const list = document.getElementById("daftarPeserta");
      list.innerHTML = "";

      if (!data || Object.keys(data).length === 0) {
        list.innerHTML = "<p class='text-center text-muted'>Belum ada peserta terdaftar.</p>";
        return;
      }

      // DIPERBAIKI: Urutkan berdasarkan nomor unik
      Object.values(data).sort((a, b) => a.nomor.localeCompare(b.nomor, undefined, { numeric: true })).forEach(p => {
        const li = document.createElement("li");
        li.innerHTML = `
            <img src="${p.foto}" alt="${p.nama}" class="img-fluid rounded-circle">
            <b class="d-block mt-2">${p.nama}</b>
            <small class="text-muted">(${p.nomor})</small>
            <div class="mt-2">
                <span class="btn-edit" onclick="editPeserta('${p.nomor}')">Edit</span> | 
                <span class="btn-hapus" onclick="hapusPeserta('${p.nomor}')">Hapus</span>
            </div>`;
        list.appendChild(li);
      });
    }

    function renderAbsensiAwal() {
      let tglTerbaru = Object.keys(dataAbsensiGlobal).sort().pop();
      const data = tglTerbaru ? dataAbsensiGlobal[tglTerbaru] : {};
      renderTabel(data); updateRekapInfo(data);
    }

    function renderTabel(data, dariFilter = false) {
      dataTabelSaatIni = data;
      const tbody = document.getElementById("absenBody");
      const cari = document.getElementById("cariInput").value.toLowerCase();
      tbody.innerHTML = "";

      let dataArray = Object.values(data).filter(item => item && item.nama);
      if (dariFilter) {
        dataArray = dataArray.filter(item => item.nama.toLowerCase().includes(cari));
      }

      if (dataArray.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Tidak ada data untuk filter ini.</td></tr>';
        return;
      }

      dataArray.sort((a, b) => {
        const valA = (a.tanggal || '') + (a.nomor || '');
        const valB = (b.tanggal || '') + (b.nomor || '');
        return valA.localeCompare(valB);
      }).forEach((a, index) => {
        const statusClass = { "Terlambat": "status-terlambat", "Bolos": "status-bolos", "Izin": "status-izin", "Sakit": "status-sakit" }[a.status] || "status-tepat";
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${index + 1}</td><td>${a.nama}</td><td>${a.nomor}</td><td>${a.waktuPulang ? new Date(a.waktuPulang).toLocaleString("id-ID", { dateStyle: 'short', timeStyle: 'short' }) : "-"}</td><td class="${statusClass}">${a.status}</td><td>${a.alasan}</td><td><span class="btn-edit" onclick="editAbsensi('${a.tanggal}', '${a.nomor}')">Edit</span> | <span class="btn-hapus" onclick="hapusAbsensi('${a.tanggal}', '${a.nomor}')">Hapus</span></td>`;
        tbody.appendChild(tr);
      });
    }

    function flattenDataWithDate(nestedData) {
      const flatArray = [];
      for (const tanggal in nestedData) {
        for (const nomor in nestedData[tanggal]) {
          flatArray.push({
            ...nestedData[tanggal][nomor],
            tanggal: tanggal // Ini adalah perbaikan krusial
          });
        }
      }
      return flatArray;
    }

    function updateRekapInfo(data) {
      const rekap = { Hadir: 0, Izin: 0, Sakit: 0, Bolos: 0 };
      Object.values(data).forEach(a => { if (a && a.alasan) rekap[a.alasan] = (rekap[a.alasan] || 0) + 1; });
      rekapInfo.textContent = `Rekap Tampilan Saat Ini -> Hadir: ${rekap.Hadir}, Izin: ${rekap.Izin}, Sakit: ${rekap.Sakit}, Bolos: ${rekap.Bolos}`;
    }

    function initBMHControls() {
      const semuaTanggal = Object.keys(dataAbsensiGlobal).sort().reverse();
      const bulanUnik = [...new Set(semuaTanggal.map(t => t.slice(0, 7)))];

      // Helper untuk meratakan data dan memastikan .tanggal ada
      const flattenDataForDates = (dateArray) => {
        const dataSlice = Object.fromEntries(dateArray.map(t => [t, dataAbsensiGlobal[t]]));
        return flattenDataWithDate(dataSlice);
      };

      bulanBtn.onclick = () => {
        const items = bulanUnik.map(t => ({ val: t, lbl: new Date(t + '-01').toLocaleDateString('id-ID', { month: 'long', year: 'numeric' }) }));
        showDropdown(items, "Pilih Bulan", bulanTerpilih => {
          showDropdown([
            { val: 'lihat', lbl: 'Tampilkan Seluruh Bulan Ini' },
            { val: 'pilih', lbl: 'Lanjut Pilih Minggu' }
          ], `Aksi untuk ${new Date(bulanTerpilih + '-01').toLocaleDateString('id-ID', { month: 'long' })}`, aksi => {
            const tglBulanIni = semuaTanggal.filter(t => t.startsWith(bulanTerpilih));
            mingguAktif = {};
            tglBulanIni.forEach(t => { const w = new Date(t).getWeek(); if (!mingguAktif[w]) mingguAktif[w] = []; mingguAktif[w].push(t); });
            bulanBtn.textContent = new Date(bulanTerpilih + '-01').toLocaleDateString('id-ID', { month: 'short', year: 'numeric' });
            [bulanBtn, mingguBtn, hariBtn].forEach(b => b.classList.remove('active')); bulanBtn.classList.add('active');
            mingguBtn.disabled = false; hariBtn.disabled = true;

            if (aksi === 'lihat') {
              const flatDataBulan = flattenDataForDates(tglBulanIni);
              renderTabel(flatDataBulan);
              updateRekapInfo(flatDataBulan);
            } else {
              mingguBtn.click();
            }
          });
        });
      };

      mingguBtn.onclick = () => {
        const items = Object.keys(mingguAktif).sort((a, b) => a - b).map(w => ({ val: w, lbl: `Minggu ke-${w}` }));
        showDropdown(items, "Pilih Minggu", mingguTerpilih => {
          showDropdown([
            { val: 'lihat', lbl: 'Tampilkan Minggu Ini' },
            { val: 'pilih', lbl: 'Lanjut Pilih Hari' }
          ], `Aksi untuk Minggu ke-${mingguTerpilih}`, aksi => {
            hariAktif = mingguAktif[mingguTerpilih].sort();
            mingguBtn.textContent = `Minggu ${mingguTerpilih}`;
            [mingguBtn, hariBtn].forEach(b => b.classList.remove('active')); mingguBtn.classList.add('active');
            hariBtn.disabled = false;

            if (aksi === 'lihat') {
              const flatDataMinggu = flattenDataForDates(hariAktif);
              renderTabel(flatDataMinggu);
              updateRekapInfo(flatDataMinggu);
            } else {
              hariBtn.click();
            }
          });
        });
      };

      hariBtn.onclick = () => {
        const items = hariAktif.map(t => ({ val: t, lbl: new Date(t).toLocaleDateString("id-ID", { weekday: 'long', day: '2-digit', month: 'short' }) }));
        showDropdown(items, "Pilih Hari", hariTerpilih => {
          hariBtn.textContent = new Date(hariTerpilih).toLocaleDateString("id-ID", { day: '2-digit', month: 'short' });
          hariBtn.classList.add('active');

          // DIPERBAIKI: Pastikan data untuk satu hari juga diratakan dengan benar
          const dataHari = dataAbsensiGlobal[hariTerpilih] || {};
          const flatDataHari = Object.values(dataHari).map(item => ({ ...item, tanggal: hariTerpilih }));

          renderTabel(flatDataHari);
          updateRekapInfo(flatDataHari);
        });
      };

      resetHariBtn.onclick = () => {
        initData();
        bulanBtn.textContent = 'Bulan'; mingguBtn.textContent = 'Minggu'; hariBtn.textContent = 'Hari';
        [bulanBtn, mingguBtn, hariBtn].forEach(b => b.classList.remove('active'));
        mingguBtn.disabled = true; hariBtn.disabled = true;
        cariInput.value = '';
      };
    }

    Date.prototype.getWeek = function () { var d = new Date(Date.UTC(this.getFullYear(), this.getMonth(), this.getDate())); var dayNum = d.getUTCDay() || 7; d.setUTCDate(d.getUTCDate() + 4 - dayNum); var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); return Math.ceil((((d - yearStart) / 86400000) + 1) / 7); };

    // --- FUNGSI UNTUK EDIT & HAPUS PESERTA ---

    // Helper untuk menampilkan modal konfirmasi yang lebih bagus
    function showConfirm(pesan, onYes) {
      const id = 'confirm-modal';
      let existingModal = document.getElementById(id);
      if (existingModal) existingModal.remove();

      const content = `<p class="text-center my-3">${pesan}</p>`;
      const actions = [
        { id: 'confirm-no', text: 'Tidak', color: '#6c757d' },
        { id: 'confirm-yes', text: 'Ya, Lanjutkan', color: 'var(--merah)' }
      ];
      const modal = createModal(id, 'Konfirmasi', content, actions);
      modal.style.display = 'flex';

      document.getElementById('confirm-yes').onclick = () => {
        onYes();
        modal.remove();
      };
      document.getElementById('confirm-no').onclick = () => modal.remove();
    }

    // Fungsi untuk Edit Peserta
    window.editPeserta = async (nomor) => {
      const id = 'edit-peserta-modal';
      const peserta = dataPesertaGlobal[nomor];
      if (!peserta) return showAlert('Data peserta tidak ditemukan.', 'gagal');

      const content = `
        <div class="form-group mb-2">
            <label for="editNama" class="form-label">Nama Peserta</label>
            <input id="editNama" value="${peserta.nama}" class="form-control">
        </div>
        <div class="form-group">
            <label for="editNomor" class="form-label">Nomor Unik</label>
            <input id="editNomor" value="${peserta.nomor}" class="form-control" disabled>
            <small class="form-text text-muted">Nomor unik tidak dapat diubah.</small>
        </div>`;
      const actions = [
        { id: 'batal-edit', text: 'Batal', color: '#6c757d' },
        { id: 'simpan-edit', text: 'Simpan Perubahan', color: 'var(--hijau)' }
      ];
      const modal = createModal(id, 'Edit Data Peserta', content, actions);
      modal.style.display = 'flex';

      document.getElementById('batal-edit').onclick = () => modal.remove();
      document.getElementById('simpan-edit').onclick = async () => {
        const namaBaru = document.getElementById('editNama').value.trim();
        if (!namaBaru) return showAlert('Nama tidak boleh kosong.', 'gagal');

        await update(ref(db, `peserta/${nomor}`), { nama: namaBaru });
        showAlert('Data peserta berhasil diperbarui.');
        modal.remove();
        initData(); // Muat ulang data untuk menampilkan perubahan
      };
    };

    // Fungsi untuk Hapus Peserta
    window.hapusPeserta = (nomor) => {
      const namaPeserta = dataPesertaGlobal[nomor]?.nama || 'peserta ini';
      showConfirm(`Anda yakin ingin menghapus <strong>${namaPeserta}</strong>? Tindakan ini tidak bisa dibatalkan.`, () => {
        remove(ref(db, `peserta/${nomor}`))
          .then(() => {
            showAlert('Peserta berhasil dihapus.');
            initData(); // Muat ulang data untuk menampilkan perubahan
          })
          .catch(err => {
            showAlert('Gagal menghapus peserta.', 'gagal');
            console.error(err);
          });
      });
    };

    // --- FITUR-FITUR BARU & AKSI ---
    window.tambahAbsenManual = () => {
      if (Object.keys(dataPesertaGlobal).length === 0) return showAlert('Data peserta belum dimuat atau kosong. Coba refresh.', 'gagal');

      // DIPERBAIKI: Urutkan opsi dropdown berdasarkan nomor unik
      const selectPeserta = Object.values(dataPesertaGlobal)
        .sort((a, b) => a.nomor.localeCompare(b.nomor, undefined, { numeric: true }))
        .map(p => `<option value="${p.nomor}">${p.nama} (${p.nomor})</option>`)
        .join('');

      const content = `
        <select id="manualPeserta" class="form-select mb-2">${selectPeserta}</select>
        <input type="date" id="manualTanggal" class="form-control mb-2">
        <input type="datetime-local" id="manualWaktu" class="form-control mb-2">
        <select id="manualStatus" class="form-select mb-2"><option>Tepat</option><option>Terlambat</option><option>Izin</option><option>Sakit</option><option>Bolos</option></select>
        <select id="manualAlasan" class="form-select"><option>Hadir</option><option>Izin</option><option>Sakit</option><option>Bolos</option></select>`;

      const m = createModal('manual-absen', 'Tambah Absen Manual', content, [{ id: 'simpanManual', text: 'Simpan', color: 'var(--hijau)' }, { id: 'batalManual', text: 'Batal', color: '#ccc' }]);
      document.getElementById('manualTanggal').valueAsDate = new Date();
      m.style.display = 'flex';

      document.getElementById('simpanManual').onclick = async () => {
        const pNo = document.getElementById('manualPeserta').value;
        const tgl = document.getElementById('manualTanggal').value;
        const wkt = document.getElementById('manualWaktu').value;
        const st = document.getElementById('manualStatus').value;
        const al = document.getElementById('manualAlasan').value;
        if (!pNo || !tgl || !wkt) return showAlert('Data belum lengkap!', 'gagal');
        await set(ref(db, `absensi/${tgl}/${pNo}`), {
          nama: dataPesertaGlobal[pNo].nama,
          nomor: pNo,
          waktuPulang: new Date(wkt).toISOString(),
          status: st,
          alasan: al,
          tanggal: tgl
        });
        showAlert('Absensi manual berhasil disimpan.');
        m.remove();
        initData();
      };
      document.getElementById('batalManual').onclick = () => m.remove();
    };

    window.tampilkanRekap = () => {
      const rekap = { Hadir: 0, Sakit: 0, Izin: 0, Bolos: 0, Tepat: 0, Terlambat: 0 };
      Object.values(dataAbsensiGlobal).forEach(tglData => {
        Object.values(tglData).forEach(a => {
          if (a.alasan) rekap[a.alasan]++;
          if (a.alasan === 'Hadir' && (a.status === 'Tepat' || a.status === 'Terlambat')) rekap[a.status]++;
        });
      });
      const tabelHTML = `<table class="table table-sm table-bordered mt-3">
            <tr class="rekap-hadir"><td>Hadir</td><td><b>${rekap.Hadir}</b> (Tepat: ${rekap.Tepat}, Terlambat: ${rekap.Terlambat})</td></tr>
            <tr class="rekap-sakit"><td>Sakit</td><td><b>${rekap.Sakit}</b></td></tr>
            <tr class="rekap-izin"><td>Izin</td><td><b>${rekap.Izin}</b></td></tr>
            <tr class="rekap-bolos"><td>Bolos</td><td><b>${rekap.Bolos}</b></td></tr>
        </table>`;
      const m = createModal('rekap-modal', 'Rekapitulasi Seluruh Data', `<canvas id="rekapChart"></canvas>${tabelHTML}`, [{ id: 'downloadRekap', text: 'Download Rekap', color: 'var(--hijau)' }, { id: 'tutupRekap', text: 'Tutup', color: '#ccc' }]);
      m.classList.add('modal-rekap'); m.style.display = 'flex';

      if (rekapChartInstance) rekapChartInstance.destroy();
      rekapChartInstance = new Chart(document.getElementById('rekapChart'), { type: 'pie', data: { labels: ['Hadir', 'Sakit', 'Izin', 'Bolos'], datasets: [{ data: [rekap.Hadir, rekap.Sakit, rekap.Izin, rekap.Bolos], backgroundColor: ['#d4edda', '#f8d7da', '#fff3cd', '#f5c6cb'], borderColor: '#fff' }] } });

      document.getElementById('downloadRekap').onclick = () => {
        const rows = [["Status", "Jumlah", "Detail"], ["Hadir", rekap.Hadir, `Tepat: ${rekap.Tepat}, Terlambat: ${rekap.Terlambat}`], ["Sakit", rekap.Sakit], ["Izin", rekap.Izin], ["Bolos", rekap.Bolos]];
        const ws = XLSX.utils.aoa_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Rekap Absensi");
        XLSX.writeFile(wb, "rekap_absensi_total.xlsx");
      };
      document.getElementById('tutupRekap').onclick = () => m.remove();
    };

    window.downloadHarian = () => {
      const dataArray = Array.isArray(dataTabelSaatIni) ? dataTabelSaatIni : Object.values(dataTabelSaatIni);
      if (dataArray.length === 0) return showAlert('Tidak ada data untuk diunduh.', 'info');

      const tanggalPertama = dataArray[0].tanggal;
      if (!tanggalPertama) return showAlert('Tidak bisa mengunduh tampilan gabungan (mingguan/bulanan). Silakan filter ke satu hari spesifik.', 'gagal');

      const isSatuHari = dataArray.every(item => item.tanggal === tanggalPertama);
      if (!isSatuHari) return showAlert('Tampilan mengandung data dari beberapa tanggal. Silakan pilih satu hari.', 'info');

      const rows = [["Tanggal", "Nama", "Nomor", "Waktu Pulang", "Status", "Alasan"]];
      dataArray.forEach(a => rows.push([a.tanggal, a.nama, a.nomor, new Date(a.waktuPulang).toLocaleString('id-ID'), a.status, a.alasan]));
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, `Absensi ${tanggalPertama}`);
      XLSX.writeFile(wb, `absensi-harian-${tanggalPertama}.xlsx`);
      showAlert('Unduhan data harian berhasil.');
    };

    // --- INISIALISASI HALAMAN ---
    if (!localStorage.getItem("isAdmin")) {
      window.location.href = "login.html";
    };
    setInterval(() => { jamSekarang.textContent = new Date().toLocaleTimeString('id-ID', { hour12: false }); }, 1000);
    const jamBatasPulangInput = document.getElementById("jamBatasPulang");
    jamBatasPulangInput.onchange = () => {
      localStorage.setItem("jamBatasPulang", jamBatasPulangInput.value);
      showAlert('Batas waktu pulang disimpan: ' + jamBatasPulangInput.value, 'info');
    };
    if (localStorage.getItem("jamBatasPulang")) {
      jamBatasPulangInput.value = localStorage.getItem("jamBatasPulang");
    }

    initData();

    // --- FUNGSI TAMBAH PESERTA ---
    const formTambah = document.getElementById('formTambah');
    formTambah.addEventListener('submit', async (e) => {
      e.preventDefault(); // Mencegah halaman reload

      const nama = document.getElementById('namaBaru').value.trim();
      const nomor = document.getElementById('nomorBaru').value.trim();
      const file = document.getElementById('fotoBaru').files[0];

      if (!nama || !nomor || !file) {
        showAlert('Harap lengkapi semua kolom!', 'gagal');
        return;
      }

      // Tampilkan pesan loading
      const submitButton = formTambah.querySelector('button[type="submit"]');
      submitButton.disabled = true;
      submitButton.textContent = 'Menyimpan...';

      // Ubah gambar menjadi format base64
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = async () => {
        const fotoBase64 = reader.result;
        try {
          // Simpan data ke Firebase
          await set(ref(db, `peserta/${nomor}`), {
            nama: nama,
            nomor: nomor,
            foto: fotoBase64
          });
          showAlert('Peserta berhasil ditambahkan!');
          formTambah.reset(); // Kosongkan form
          initData(); // Muat ulang semua data untuk memperbarui tampilan
        } catch (error) {
          console.error("Gagal menambah peserta:", error);
          showAlert('Terjadi kesalahan saat menyimpan data.', 'gagal');
        } finally {
          // Kembalikan tombol ke keadaan semula
          submitButton.disabled = false;
          submitButton.textContent = 'Tambah Peserta';
        }
      };
      reader.onerror = () => {
        showAlert('Gagal memproses gambar.', 'gagal');
        submitButton.disabled = false;
        submitButton.textContent = 'Tambah Peserta';
      };
    });

    // Salin sisa fungsi lain yang tidak berubah dari respons sebelumnya ke sini (seperti editPeserta, hapusPeserta, dll)
    // Saya meringkasnya di sini agar tidak terlalu panjang, tetapi pastikan semua fungsi window.xxx ada di file Anda.
    window.hapusSemuaData = () => {
      showConfirm('<strong>PERINGATAN!</strong> Anda yakin ingin menghapus <strong>SELURUH</strong> data absensi? Tindakan ini tidak dapat dibatalkan.', () => {
        set(ref(db, 'absensi'), null)
          .then(() => {
            showAlert('Seluruh data absensi telah dihapus.', 'info');
            initData();
          })
          .catch(err => {
            showAlert('Gagal menghapus semua data.', 'gagal');
            console.error(err);
          });
      });
    };
    window.exportCSV = () => {
      if (Object.keys(dataAbsensiGlobal).length === 0) return showAlert('Tidak ada data absensi sama sekali.', 'gagal');

      const flatData = flattenDataWithDate(dataAbsensiGlobal);
      flatData.sort((a, b) => ((a.tanggal || '') + (a.nomor || '')).localeCompare((b.tanggal || '') + (b.nomor || '')));

      const rows = [["Tanggal", "Nama", "Nomor", "Waktu Pulang", "Status", "Alasan"]];
      flatData.forEach(a => rows.push([a.tanggal, a.nama, a.nomor, a.waktuPulang ? new Date(a.waktuPulang).toLocaleString('id-ID') : '-', a.status, a.alasan]));

      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Absensi Full");
      XLSX.writeFile(wb, "data_absensi_full.xlsx");
      showAlert('Unduhan semua data berhasil.');
    };


    window.editAbsensi = async (t, n) => { const a = dataAbsensiGlobal[t][n]; const c = `<input type="datetime-local" id="editWaktu" value="${new Date(a.waktuPulang).toISOString().slice(0, 16)}" class="form-control mb-2"><select id="editStatus" class="form-select"></select>`; const m = createModal('edit-absen', `Edit Absen: ${a.nama}`, c, [{ id: 's', text: 'Simpan', c: 's', color: 'var(--hijau)' }, { id: 'b', text: 'Batal', c: 'b', color: '#ccc' }]); m.style.display = 'flex'; document.getElementById('s').onclick = async () => { await update(ref(db, `absensi/${t}/${n}`), { waktuPulang: new Date(document.getElementById('editWaktu').value).toISOString(), status: document.getElementById('editStatus').value }); showAlert('Absensi diperbarui.'); m.remove(); initData(); }; document.getElementById('b').onclick = () => m.remove(); };

    window.hapusAbsensi = (tanggal, nomor) => {
      const namaPeserta = dataAbsensiGlobal[tanggal]?.[nomor]?.nama || 'data ini';
      showConfirm(`Anda yakin ingin menghapus data absensi milik <strong>${namaPeserta}</strong> pada tanggal ${tanggal}?`, () => {
        remove(ref(db, `absensi/${tanggal}/${nomor}`))
          .then(() => {
            showAlert('Data absensi berhasil dihapus.');
            initData();
          })
          .catch(err => {
            showAlert('Gagal menghapus data.', 'gagal');
            console.error(err);
          });
      });
    };

  </script>
</body>

</html>