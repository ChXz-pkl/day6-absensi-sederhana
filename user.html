<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Absensi Peserta</title>
    <style>
        /* ===== RESET & GLOBAL ===== */
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            overflow-x: hidden;
            font-family: 'Segoe UI', sans-serif;
            background: #f0f4f8;
            color: #333;
        }

        /* CONTAINER */
        .container {
            max-width: 1000px;
            margin: auto;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        /* ===== TYPOGRAPHY & HEADERS ===== */
        body {
            padding: 16px;
        }

        h2 {
            font-size: 1.75rem;
            color: #2c3e50;
            text-align: center;
            margin: 24px 0;
            position: relative;
        }

        h2::after {
            content: "";
            display: block;
            width: 60px;
            height: 4px;
            background: #4caf50;
            margin: 8px auto 0;
            border-radius: 2px;
        }

        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            padding: 0 12px;
        }

        .header-container .left,
        .header-container .right {
            width: 100px;
            text-align: center;
        }

        .header-container .center {
            flex: 1;
            text-align: center;
        }

        .header-container h2 {
            margin: 0;
            font-size: 1.75rem;
            color: #2c3e50;
            position: relative;
        }

        .kembali-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 7px;
            border-radius: 6px;
            cursor: pointer
        }

        .jam {
            position: absolute;
            top: 35px;
            background: rgba(255, 255, 255, 0.8);
            padding: 6px 12px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.95rem;
            color: #2c3e50;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }




        /* ===== FORM & PREVIEW ===== */
        .wrap-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 24px;
        }

        .form-kiri,
        .daftar-kanan {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 24px;
            width: 100%;
            max-width: 360px;
        }

        input,
        select,
        button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 6px;
            transition: border-color .2s;
        }

        input:focus,
        select:focus {
            border-color: #4caf50;
            outline: none;
        }

        button {
            background: #4caf50;
            color: #fff;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: background .2s;
        }

        button:hover {
            background: #388e3c;
        }

        .preview-foto {
            text-align: center;
            margin: 16px 0;
        }

        .preview-foto img {
            display: block;
            margin: 0 auto;
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid #4caf50;
        }

        .status {
            text-align: center;
            margin-top: 12px;
            font-weight: bold;
            font-size: .9rem;
        }

        /* ===== DAFTAR PESERTA ===== */
        .daftar-kanan h3 {
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 12px;
        }

        ul#daftarPeserta {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 240px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #fff;
        }

        ul#daftarPeserta li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: .95rem;
            color: #555;
        }

        ul#daftarPeserta li:last-child {
            border-bottom: none;
        }

        /* ===== TABEL ABSENSI ===== */
        h2+input {
            display: block;
            margin: 16px auto;
            max-width: 360px;
        }

        .tabel-container {
            overflow-x: auto;
            margin-top: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        thead th {
            background: #4caf50;
            color: #fff;
            padding: 12px;
            font-size: .95rem;
            text-align: left;
        }

        tbody tr:nth-child(even) {
            background: #f9f9f9;
        }

        tbody tr:hover {
            background: #f1fdf1;
        }

        td {
            padding: 10px;
            font-size: .9rem;
            border-bottom: 1px solid #eee;
        }

        /* status badge */
        .status-tepat,
        .status-terlambat {
            font-weight: bold;
        }

        .status-tepat {
            color: #2e7d32;
        }

        .status-terlambat {
            color: #c62828;
        }

        .status-bolos {
            color: #b71c1c;
            font-weight: bolder;
        }

        .status-izin,
        .status-sakit {
            color: #f57c00;
            font-weight: bold;

        }



        /* ===== RESPONSIVE ===== */
        /* ============================= */
        /* ======== RESPONSIVE ========= */
        /* ============================= */

        /* Tablet dan ke bawah (max-width: 768px) */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .wrap-container {
                flex-direction: column;
                align-items: center;
            }

            .form-kiri,
            .daftar-kanan {
                max-width: 100%;
                padding: 16px;
            }

            input,
            select,
            button {
                font-size: 0.95rem;
                padding: 10px;
            }

            .preview-foto img {
                width: 70px;
                height: 70px;
            }

            ul#daftarPeserta li {
                font-size: 0.9rem;
                padding: 8px;
            }

            table thead th,
            table td {
                padding: 8px;
                font-size: 0.85rem;
            }

            .status {
                font-size: 0.9rem;
            }
        }

        /* HP kecil (max-width: 480px) */
        @media (max-width: 480px) {
            h2 {
                font-size: 1.4rem;
                margin: 12px 0;
            }

            .header-container {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .header-container .left,
            .header-container .right {
                width: 100%;
                text-align: center;
            }

            .kembali-btn {
                font-size: 0.95rem;
                padding: 4px 10px;
            }

            .jam {
                font-size: 0.9rem;
                padding: 4px 12px;
                position: relative;
                top: 0;
                background: rgba(255, 255, 255, 0.8);
                padding: 6px 12px;
                border-radius: 12px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            }

            button,
            input,
            select {
                font-size: 0.9rem;
                padding: 8px;
            }

            .preview-foto img {
                width: 60px;
                height: 60px;
            }

            ul#daftarPeserta {
                max-height: 180px;
            }

            table thead th,
            table td {
                padding: 6px;
                font-size: 0.8rem;
            }

            .status {
                font-size: 0.85rem;
            }
        }

        /* Layar besar (min-width: 1024px) */
        @media (min-width: 1024px) {

            .form-kiri,
            .daftar-kanan {
                max-width: 400px;
            }

            h2 {
                font-size: 2rem;
            }

            .jam {
                font-size: 1rem;
            }

            .kembali-btn {
                font-size: 1rem;
            }

            table thead th,
            table td {
                font-size: 1rem;
            }
        }
    </style>
</head>

<body>

    <div class="container">

        <div class="header-container">
            <div class="left">
                <button class="kembali-btn" onclick="location.href='index.html'">Kembali</button>
            </div>
            <div class="center">
                <h2>Form Absensi Peserta</h2>
            </div>
            <div class="right">
                <div class="jam" id="jamSekarang">--:--:--</div>
            </div>
        </div>



        <div class="wrap-container">
            <div class="form-kiri">
                <form id="formAbsen">
                    <input type="text" id="nomorInput" placeholder="Masukkan Nomor Anda" required>
                    <select id="alasanInput">
                        <option value="Hadir">Hadir</option>
                        <option value="Sakit">Sakit</option>
                        <option value="Izin">Izin</option>
                        <option value="Bolos">Bolos</option>
                    </select>

                    <div id="previewPeserta" class="preview-foto"></div>

                    <button type="button" id="btnMasuk">Absen Masuk</button>
                    <button type="button" id="btnPulang">Absen Pulang</button>
                    <div class="status" id="statusPesan"></div>
                </form>
            </div>

            <div class="daftar-kanan">
                <h3>Daftar Peserta</h3>
                <ul id="daftarPeserta"></ul>
            </div>
        </div>

        <h2>Data Absensi</h2>
        <input type="text" id="cariInput" placeholder="Cari nama..." oninput="renderTabel()">

        <div class="tabel-container">
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Nama</th>
                        <th>Nomor</th>
                        <th>Pulang</th>
                        <th>Status</th>
                        <th>Alasan</th>
                    </tr>
                </thead>
                <tbody id="absenBody"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import {
            getDatabase, ref, set, update, get, child
        } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDOmBwvur0gJVvyzqLff-e_YjFpkyYvOCM",
            authDomain: "absensi-chx.firebaseapp.com",
            databaseURL: "https://absensi-chx-default-rtdb.firebaseio.com",
            projectId: "absensi-chx",
            storageBucket: "absensi-chx.appspot.com",
            messagingSenderId: "891248981960",
            appId: "1:891248981960:web:c0060ff1de18e61608b2fd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const pesertaRef = ref(db, 'peserta');
        const absensiRef = ref(db, 'absensi');

        // Load daftar peserta
        async function loadPeserta() {
            const snap = await get(pesertaRef);
            const list = document.getElementById("daftarPeserta");
            list.innerHTML = "";
            if (snap.exists()) {
                Object.entries(snap.val()).forEach(([nomor, p]) => {
                    const li = document.createElement("li");
                    li.textContent = `${p.nama} (${nomor})`;
                    list.appendChild(li);
                });
            }
        }

        // Absen hanya pulang
        async function absen(tipe) {
            const nomor = document.getElementById("nomorInput").value.trim();
            const alasan = document.getElementById("alasanInput").value;
            const statusPesan = document.getElementById("statusPesan");
            const preview = document.getElementById("previewPeserta");

            const pesertaSnap = await get(child(ref(db), `peserta/${nomor}`));
            if (!pesertaSnap.exists()) {
                statusPesan.textContent = "❌ Nomor tidak ditemukan!";
                statusPesan.style.color = "red";
                setTimeout(() => statusPesan.textContent = "", 2500);
                return;
            }

            const p = pesertaSnap.val();
            preview.innerHTML = p.foto
                ? `<img src="${p.foto}"/><div><strong>${p.nama}</strong></div>`
                : `<div><strong>${p.nama}</strong></div>`;
            setTimeout(() => preview.innerHTML = "", 2500);

            const now = new Date().toISOString();
            const tanggal = now.slice(0, 10);
            const todayRef = ref(db, `absensi/${tanggal}/${nomor}`);
            const todaySnap = await get(todayRef);
            const batasTerlambat = localStorage.getItem("jamBatas") || "08:00";


            // ===== ABSEN MASUK =====
            if (tipe === "masuk") {
                if (todaySnap.exists() && todaySnap.val().waktuMasuk) {
                    statusPesan.textContent = "❌ Sudah absen masuk!";
                    statusPesan.style.color = "red";
                    return;
                }

                const waktuSekarang = now.split("T")[1].slice(0, 5); // jam:menit
                const status = waktuSekarang > batasTerlambat ? "Terlambat" : "Tepat Waktu";

                await set(todayRef, {
                    nama: p.nama,
                    nomor,
                    waktuMasuk: now,
                    waktuPulang: "",
                    alasan,
                    status
                });

                statusPesan.textContent = "✅ Absen masuk berhasil.";
                statusPesan.style.color = "green";
            }

            // ===== ABSEN PULANG =====
            else if (tipe === "pulang") {
                const jamPulang = new Date(now);
                const jam = jamPulang.getHours();
                const menit = jamPulang.getMinutes();
 const hari = jamPulang.getDay(); // 0 = Minggu, 1 = Senin, ..., 2 = Selasa, ..., 6 = Sabtu
                let statusPulang = "Terlambat Pulang";

                if (alasan === "Sakit" || alasan === "Izin") {
                    statusPulang = alasan; // langsung jadi 'Sakit' atau 'Izin'
                }

if (hari === 2) { // Hari Selasa
    if (jam < 15 || (jam === 15 && menit < 30)) {
        statusPulang = "Bolos";
    } else if (jam === 15 && menit <= 30) {
        statusPulang = "Tepat";
    } else {
        statusPulang = "Terlambat";
    }
} else {
    if (jam < 16) {
        statusPulang = "Bolos";
    } else if (jam === 16 && menit <= 30) {
        statusPulang = "Tepat";
    } else {
        statusPulang = "Terlambat";
    }
}

                }



                if (!todaySnap.exists()) {
                    await set(todayRef, {
                        nama: p.nama,
                        nomor,
                        waktuMasuk: "",
                        waktuPulang: now,
                        alasan,
                        status: statusPulang
                    });
                } else {
                    const data = todaySnap.val();
                    if (data.waktuPulang) {
                        statusPesan.textContent = "❌ Sudah absen pulang!";
                        statusPesan.style.color = "red";
                        return;
                    }

                    await update(todayRef, {
                        waktuPulang: now,
                        status: statusPulang
                    });
                }

                const statusMap = {
                    "Tepat": { teks: "✅ Pulang tepat waktu!", warna: "green" },
                    "Terlambat": { teks: "⚠️ Pulang terlambat!", warna: "orange" },
                    "Izin": { teks: "🟡 Pulang karena izin", warna: "#f57c00" },
                    "Sakit": { teks: "🟡 Pulang karena sakit", warna: "#f57c00" },
                    "Bolos": { teks: "❌ Bolos! Pulang terlalu cepat", warna: "red" },
                };

                const statusInfo = statusMap[statusPulang] || { teks: `✅ Absen pulang berhasil (${statusPulang})`, warna: "black" };

                statusPesan.textContent = statusInfo.teks;
                statusPesan.style.color = statusInfo.warna;

                setTimeout(() => {
                    statusPesan.textContent = "";
                }, 2500);
            }


            document.getElementById("formAbsen").reset();
            renderTabel();
        }


        // Render tabel absensi
        // Render tabel absensi
        async function renderTabel() {
            const tbody = document.getElementById("absenBody");
            const q = document.getElementById("cariInput").value.toLowerCase();
            tbody.innerHTML = "";

            const pesertaSnap = await get(pesertaRef);
            const snap = await get(absensiRef);
            if (!snap.exists() || !pesertaSnap.exists()) return;

            const semuaPeserta = pesertaSnap.val();
            const totalPeserta = Object.keys(semuaPeserta).length;

            const now = new Date();
            const tanggalHariIni = now.toISOString().slice(0, 10);
            const dataHariIni = snap.val()[tanggalHariIni];

            // 🟥 Jika tidak ada data sama sekali hari ini
            if (!dataHariIni) {
                const tr = document.createElement("tr");
                tr.innerHTML = `
            <td colspan="6" style="text-align:center; color:#999;">
                ❗ Belum ada data absensi hari ini.
            </td>`;
                tbody.appendChild(tr);
                return;
            }

            const jumlahAbsen = Object.keys(dataHariIni).length;

            // ✅ Jika sudah semua absen, tampilkan hanya pesan saja
            if (jumlahAbsen === totalPeserta) {
                const tr = document.createElement("tr");
                tr.innerHTML = `
            <td colspan="6" style="text-align:center; font-weight:bold; color:green;">
                ✅ Absensi lengkap hari ini (${jumlahAbsen}/${totalPeserta})
            </td>`;
                tbody.appendChild(tr);
                return;
            }

            // ⏳ Jika belum lengkap, tampilkan data peserta
            let no = 1;
            Object.entries(dataHariIni).forEach(([nomor, a]) => {
                if (q && (a.nama || "").toLowerCase().includes(q) === false) return;

                const tr = document.createElement("tr");
                tr.innerHTML = `
        <td>${no++}</td>
        <td>${a.nama}</td>
        <td>${a.nomor}</td>     
        <td>${a.waktuPulang ? new Date(a.waktuPulang).toLocaleString("id-ID") : "-"}</td>
        <td class="${a.status === 'Terlambat' ? 'status-terlambat' : a.status === 'Bolos' ? 'status-bolos' : a.status === 'Izin' ? 'status-izin' : a.status === 'Sakit' ? 'status-sakit' : 'status-tepat'}">${a.status || "-"}</td>
        <td>${a.alasan}</td>
        `;
                tbody.appendChild(tr);
            });
        }
        // <td>${a.waktuMasuk ? new Date(a.waktuMasuk).toLocaleString("id-ID") : "-"}</td>
        function updateJam() {
            const now = new Date();
            const jam = now.toLocaleTimeString("id-ID", { hour12: false });
            document.getElementById("jamSekarang").textContent = jam;
        }
        setInterval(updateJam, 1000);
        updateJam();

        // Global access
        window.absen = absen;
        window.renderTabel = renderTabel;

        // Init
        loadPeserta();
        renderTabel();

        document.getElementById("btnMasuk").style.display = "none";
        // document.getElementById("btnMasuk").onclick = () => absen('masuk');
        const btnPulang = document.getElementById("btnPulang");
        btnPulang.onclick = async () => {
            // Nonaktifkan tombol
            btnPulang.disabled = true;
            btnPulang.style.backgroundColor = "#ccc"; // abu-abu
            btnPulang.style.color = "#666"; // teks agak gelap
            btnPulang.textContent = "Memproses...";


            await absen("pulang");

            // Jeda 3 detik
            setTimeout(() => {
                btnPulang.disabled = false;
                btnPulang.style.backgroundColor = "#4caf50"; // hijau semula
                btnPulang.style.color = "#fff";
                btnPulang.textContent = "Absen Pulang";
            }, 3000);

        };

    </script>

</body>

</html>
